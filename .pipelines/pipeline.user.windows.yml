environment:
  host:
    os: 'windows'
    flavor: 'server'
    version: '2016'
  runtime:
    provider: 'appcontainer'
    image: 'cdpxwin.azurecr.io/global/vse2017u7/vse2017u7-external-winltsc2016-20190731:latest'
    source_mode: 'link'

version:
  major: 1
  minor: 0
  name: 'Service-Fabric-Observer'
  system: 'patch'
  
package_sources:
  nuget:
    feeds:
      'Toolset': 'https://msazure.pkgs.visualstudio.com/_packaging/Toolset/nuget/v3/index.json'
      'Official': 'https://api.nuget.org/v3/index.json'
      'PipelineBuildSupplement': 'https://msazure.pkgs.visualstudio.com/_packaging/PipelineBuildSupplement/nuget/v3/index.json'
      
restore:
  commands:
    - !!defaultcommand
      name: 'Nuget Restore'
      command: 'build\scripts\restore.cmd'

build:
  commands:
    - !!buildcommand
      name: 'Build FO'
      command: 'build\scripts\build.cmd'
      fail_on_stderr: false
      artifacts:
        - from: 'FabricObserver\x64\bin\Release'
          to: 'FO'
          include:
            - '**/*'
          signing_options:
            profile: 'external_distribution'
        - from: 'FabricObserver\x64\bin\Release'
          to: 'SignedFO'
          include:
            - 'FabricObserver.exe'
          signing_options:
            profile: '135020002'
        - from: 'FabricObserver\x64\bin\Release'
          to: 'SignedFO'
          include:
            - 'NLog.dll'
           
static_analysis_options:
  binskim_options: 
      files_to_scan:     
        - from: 'FabricObserverWeb\bin\Release\netcoreapp2.2\win7-x64\'
            exclude:                         
              - 'FabricObserverWeb.dll'
  fxcop_options:  
    disable_tool_scan: true

test:
  commands:
    - !!testcommand
      name: 'VsTest FabricObserver Unit Tests'
      command: 'build\scripts\test.cmd'
      fail_on_stderr: false
      logs:
        - to: 'FO-test-logs'
          include:
            - '**/*.trx'
            - '**/*.coverage'
      testresults:
        - from: 'FabricObserverTests\bin\Release\TestResults'
          title: 'FabricObserver Unit Tests Results'
          type: 'vstest'
          include:
            - '**/*.trx'
            - '**/*.coverage'
